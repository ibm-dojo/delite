<!DOCTYPE>
<html>
<head>
	<title>dui/handlebars unit test</title>
	<script type="text/javascript" src="../boilerplate.js"></script>

	<script type="text/javascript">
		require([
			"doh/runner",
			"dui/handlebars", "dui/register", "dui/Widget",
			"dojo/domReady!"
		], function (doh, handlebars, register, Widget) {
			doh.register("handlebars", [
				// Test using handlebars! as a plugin to load a template
				function load() {
					var d = new doh.Deferred();
					require(["dui/handlebars!dui/tests/infrastructure/templates/SimpleHandlebarsButton.html"], d.getTestCallback(function (br) {
						// Test that function returned from dui/handlebars! creates the template correctly
						var TestButton = register("test-button", [HTMLButtonElement, Widget], {
							iconClass: "originalClass",
							label: "original label",
							buildRendering: br
						});
						myButton = new TestButton();
						doh.is("button", myButton.tagName.toLowerCase(), "root node exists");
						doh.is("span", myButton.firstChild.tagName.toLowerCase(), "icon node exists too");
						doh.is("duiReset originalClass", myButton.firstChild.className, "icon class set");
						doh.is("original label", myButton.textContent.trim(), "label set");
					}));
					return d;
				},

				// Test that updates to widget are reflected into template
				function update() {
					myButton.label = "new label";
					doh.is("new label", myButton.textContent.trim(), "label updated");

					myButton.iconClass = "newClass";
					doh.is("duiReset newClass", myButton.firstChild.className, "icon class set");
				},

				// Test {{#if}}
				function branching() {
					var d = new doh.Deferred();
					require(["dui/handlebars!dui/tests/infrastructure/templates/HandlebarsButton.html"], d.getTestCallback(function (br) {
						// Test false if condition
						var NoLabelButton = register("no-label-button", [HTMLButtonElement, Widget], {
							iconClass: "originalClass",
							showLabel: false,
							label: "original label",
							buildRendering: br
						});
						myButton = new NoLabelButton();
						doh.is("button", myButton.tagName.toLowerCase(), "root node exists");
						doh.is("span", myButton.firstChild.tagName.toLowerCase(), "icon node exists too");
						doh.is("duiReset originalClass", myButton.firstChild.className, "icon class set");
						doh.is("", myButton.textContent.trim(), "no label");
						myButton.label = "new label";
						doh.is("", myButton.textContent.trim(), "still no label");

						// Test true if condition
						var LabelButton = register("label-button", [HTMLButtonElement, Widget], {
							iconClass: "originalClass",
							showLabel: true,
							label: "original label",
							buildRendering: br
						});
						myButton = new LabelButton();
						doh.is("button", myButton.tagName.toLowerCase(), "root node exists");
						doh.is("span", myButton.firstChild.tagName.toLowerCase(), "icon node exists too");
						doh.is("duiReset originalClass", myButton.firstChild.className, "icon class set");
						doh.is("original label", myButton.textContent.trim(), "label");

						// Make sure that changes still work
						myButton.label = "new label";
						doh.is("new label", myButton.textContent.trim(), "label updated");
					}));
					return d;
				},

				// Testing for special properties
				function specialProps() {
					var SpecialPropsWidget = register("special-props", [HTMLElement, Widget], {
						inputClass: "originalClass",	// attribute called "class" but property called "className"
						inputValue: "original value",	// must be set as property
						role: "originalRole",			// must be set as attribute
						buildRendering: handlebars.compile(
								'<special-props><input class="{{inputClass}}" value="{{inputValue}}" role="{{role}}"/></special-props>'
						)
					});
					var mySpecialPropsWidget = new SpecialPropsWidget();
					input = mySpecialPropsWidget.children[0];

					doh.is("original value", input.value, "value set as property");
					doh.is("originalClass", input.className, "class set even though property is called className, not class");
					doh.is("originalRole", input.getAttribute("role"), "role set as attribute");

					mySpecialPropsWidget.mix({
						inputClass: "newClass",
						inputValue: "new value",
						role: "newRole"
					});
					doh.is("new value", input.value, "value changed");
					doh.is("newClass", input.className, "class changed");
					doh.is("newRole", input.getAttribute("role"), "role changed");

					// TODO: implement and then test reverse binding, from input.value --> widget.value?
				},

				// Test that widgets in the templates are instantiated, and respond to updates in the main widget.
				function widgetsInTemplate() {
					register("simple-heading", [HTMLElement, Widget], {
						text: "",
						buildRendering: handlebars.compile("<simple-heading>{{text}}</simple-heading>")
					});

					// This widget uses sub-widgets test-button (defined in first test) and also simple-heading.
					var ComplexWidget = register("widgets-in-template", [HTMLElement, Widget], {
						heading: "original heading",
						content: "original content",
						buttonLabel: "original button label",
						buildRendering: handlebars.compile(
								'<widgets-in-template>' +
										'<simple-heading text="{{heading}}"></simple-heading>' +
										'<span>{{content}}</span>' +
										'<button is="test-button" label="{{buttonLabel}}"></button>' +
										'</widgets-in-template>'
						)
					});

					var myComplexWidget = new ComplexWidget(),
							headingWidget = myComplexWidget.getElementsByTagName("simple-heading")[0],
							buttonWidget = myComplexWidget.getElementsByTagName("button")[0];
					doh.t(headingWidget.buildRendering, "heading widget was instantiated");
					doh.is("original heading", headingWidget.textContent, "heading widget got title from main widget");
					doh.t(buttonWidget.buildRendering, "button widget was instantiated");
					doh.is("original button label", buttonWidget.textContent.trim(), "button widget got label from main widget");

					myComplexWidget.mix({
						heading: "new heading",
						buttonLabel: "new button label"
					});
					doh.is("new heading", headingWidget.textContent, "heading changed");
					doh.is("new button label", buttonWidget.textContent.trim(), "button changed");
				}

			]);	// doh.register()

			doh.run();
		});	// require()

	</script>
</head>
<body>
<h1>dui/handlebars Unit Test</h1>

<p>Check console for results.</p>
</body>
</html>
