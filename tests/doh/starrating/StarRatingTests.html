<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>StarRating Tests</title>
<script type="text/javascript" src="../../boilerplate.js"></script>
<script type="text/javascript" src="../TestUtil.js"></script>
<script language="JavaScript" type="text/javascript">
	var timeoutInterval = 1000;
	var val = 0;
	require([
		"doh/runner",	//doh functions
		"dui/register",
		"dojo/query",
		"dojo/string",
		"dojo/sniff",
		"dojo/dom-geometry",
		"dui/StarRating",
		"dojo/domReady!"
	], function(runner, register, query, string, has, domGeometry, StarRating){

		increment = function(suffix){
			if(val == 7){ return; }
			val += 0.5;
			dom.byId("star").value = val;
			document.getElementById("value").innerHTML = val;
		};

		decrement = function(suffix){
			if(val == 0){ return; }
			val -= 0.5;
			dom.byId("star").value = val;
			document.getElementById("value").innerHTML = val;
		};

		register.parse();

		// Create two rating widgets programmaticaly
		var rating = new StarRating({
			id: "editablestar6",
			image:"../../images/star-4.png",
			maximum:7,
			editable:true,
			editHalfValues: true,
			value: 3.5
		}).placeAt("editablestar6", 'replace');
		rating.watch('value', function(name, oldValue, value){
			document.getElementById("editablestar6value").innerHTML = "Rating is " + value + " star" + (value > 1 ? "s" : "");				
		});
		rating.startup();

		var checkRating = function(ratingId, maximum, expectedValue){
			var rating = dom.byId(ratingId);
			var stars = query('div', ratingId);
			var i, node;
			runner.assertEqual(expectedValue, rating.value, 'the rating value is not the expected one for ' + ratingId);
			runner.assertEqual(maximum, stars.length, "number of stars displayed on node with id star");
			for(i = 0; i < stars.length; i++){
				node = stars[i];
				if(i > (expectedValue - 1)){
					if(i == (expectedValue - 0.5)){
						runner.assertEqual("duiStarRatingStarIcon duiStarRatingHalfStar", node.className, 'star ' + i + ' should be half empty in ' + ratingId);
					}else{
						runner.assertEqual("duiStarRatingStarIcon duiStarRatingEmptyStar", node.className, 'star ' + i + ' should be empty in ' + ratingId);
					}
				}else{
					runner.assertEqual("duiStarRatingStarIcon duiStarRatingFullStar", node.className, 'star ' + i + ' should be full in ' + ratingId);
				}
			}
		};
		
		var fireMouseUpAndDownOnStar = function(ratingId, starIndex /*first index is 0*/, pixelsFromCenter/*?Number of pixels from the center of the star for the clientX coordinate of events*/){
			var starNode = query('div', ratingId)[starIndex];
			var starBox = domGeometry.position(starNode); // position of the parent div (image bigger than that because it is a sprite)
			var clientX = starBox.x + (starBox.w / 2) + (pixelsFromCenter ? pixelsFromCenter : 0);
			fireOnMouseDown(starNode, {clientX: clientX});
			fireOnMouseUp(starNode, {clientX: clientX});
		};

		var fireMouseUpAndDownOnZeroSettingArea = function(ratingId){
			var node = document.getElementById(ratingId);
			var starBox = domGeometry.position(node);
			var clientX = starBox.x;
			fireOnMouseDown(node, {clientX: clientX});
			fireOnMouseUp(node, {clientX: clientX});
		};

		var defaultEditableRatingTest = function(ratingId, tooltipText, halfStars, zeroSetting, expectedInitialValue){
			var expected;
			// Check initial rating
			checkRating(ratingId, 7, expectedInitialValue);
			// check rating change after firing down and up events on a star
			fireMouseUpAndDownOnStar(ratingId, 2, -1);
			expected = (halfStars ? 2.5 : 3);
			checkRating(ratingId, 7, expected);
			// set zero rating
			fireMouseUpAndDownOnZeroSettingArea(ratingId);
			expected = zeroSetting ? 0 : 0.5;
			checkRating(ratingId, 7, expected);
			///////////////////////////////////////////
			// TODO: CHECK USING MOVE TO SET VALUES
			///////////////////////////////////////////
		};

		runner.register("dui.mobile.test.doh.StarRatingTests", [
			{
				name: 'test read only ltr',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					var plusButton = document.getElementById('starplus');
					var minusButton = document.getElementById('starminus');
					setTimeout(deferred.getTestCallback(function(){
						var i;
						var expected;
						// Check initial rating
						checkRating('star', 7, 0);
						// Check rating change when clicking the plus button
						for(i=0; i < 14; i++){
							fireOnClick(plusButton);
							expected = (i + 1) * 0.5;
							checkRating('star', 7, expected);
						}
						// Check rating change when clicking the minus button
						for(i=0; i < 14; i++){
							fireOnClick(minusButton);
							expected = (13 - i) * 0.5;
							checkRating('star', 7, expected);
						}
						// Fire down and up events on a star: doesn't change anything
						fireMouseUpAndDownOnStar('star', 2, -1);
						checkRating('star', 7, 0);
					}), 2000);
					return deferred;
				}
			},
			{
				name: 'test editable ltr',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					setTimeout(deferred.getTestCallback(function(){
						defaultEditableRatingTest('editablestar1', '${value}', false, true, 0);
					}), 100);
					return deferred;
				}
			},
			{
				name: 'test editable half values ltr',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					setTimeout(deferred.getTestCallback(function(){
						defaultEditableRatingTest('editablestar2', '${value}', true, true, 0);
					}), 100);
					return deferred;
				}
			},
			{
				name: 'test editable half values no zero setting ltr',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					setTimeout(deferred.getTestCallback(function(){
						defaultEditableRatingTest('editablestar5', '${value}', true, false, 0.5);
					}), 100);
					return deferred;
				}
			},
			{
				name: 'test editable programmatic onchange ltr',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					setTimeout(deferred.getTestCallback(function(){
						var expected;
						var id = 'editablestar6';
						var messageNode = document.getElementById(id + 'value');
						// Check initial rating
						checkRating(id, 7, 3.5);
						// Check message
						runner.assertEqual('Rating is 3.5 stars', messageNode.innerHTML, 'message is not the one expected for ' + id);
						// check rating change after firing down and up events on a star
						fireMouseUpAndDownOnStar(id, 2, -1);
						expected = 2.5;
						checkRating(id, 7, expected);
						// Check message
						runner.assertEqual('Rating is 2.5 stars', messageNode.innerHTML, 'message is not the one expected for ' + id);
						// set zero rating
						fireMouseUpAndDownOnZeroSettingArea(id);
						expected = 0;
						checkRating(id, 7, expected);
						// Check message
						runner.assertEqual('Rating is 0 star', messageNode.innerHTML, 'message is not the one expected for ' + id);
						///////////////////////////////////////////
						// TODO: CHECK USING MOVE TO SET VALUES
						///////////////////////////////////////////
					}), 100);
					return deferred;
				}
			},
			{
				name: 'test stateful properties',
				timeout: 4000,
				runTest: function(){
					var deferred = new doh.Deferred();
					setTimeout(deferred.getTestCallback(function(){
						var ratingId = 'editablestar2';
						var rating = dom.byId(ratingId);
						var newMax = 5;
						var expected;
						rating.maximum = newMax;
						checkRating(ratingId, newMax, 0);
						rating.editable = false;
						fireMouseUpAndDownOnStar(ratingId, 1, -1);
						checkRating(ratingId, newMax, 0);
						rating.editHalfValues = false;
						rating.editable = true;
						fireMouseUpAndDownOnStar(ratingId, 1, -1);
						expected = 2;
						checkRating(ratingId, newMax, expected);
						rating.zeroAreaWidth = 0;
						rating.editHalfValues = true;
						fireMouseUpAndDownOnZeroSettingArea(ratingId);
						expected = 0.5;
						checkRating(ratingId, newMax, expected);
					}), 100);
					return deferred;
				}
			}
		]);
		runner.run();
	})
</script>
</head>
<body>
	<div>
		<div>
			<dui-starrating id="star" image="../../images/star-4.png" maximum=7></dui-starrating>
			<span id="value">0</span><br>
			<button id="starminus" type="button" onclick="decrement()">&minus;</button>
			<button id="starplus" type="button" onclick="increment()">+</button>
			<p>
			Editable: <dui-starrating id="editablestar1" image="../../images/star-4.png" maximum=7 editable=true></dui-starrating>
			<p>
			Editable (half values increment): <dui-starrating id="editablestar2" image="../../images/star-4.png" maximum=7 editable=true editHalfValues=true></dui-starrating>
			<p>
			No zero setting: <dui-starrating id="editablestar5" image="../../images/star-4.png" maximum=7 editable=true editHalfValues=true value=0.5 zeroAreaWidth=0></dui-starrating>
			<p>
			Programmatic: <span id="editablestar6"></span><br>
			<span id="editablestar6value">Rating is 3.5 stars</span>
		</div>
	</div>	
</body>
</html>
